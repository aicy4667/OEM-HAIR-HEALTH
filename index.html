
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OEMï½œåŒ…è£åå¥½å¿«é€Ÿé‡æ¸…å™¨ï¼ˆåŒ–å¦å“ / ä¿å¥é£Ÿå“ï¼‰</title>
  <style>
    :root{
      /* ç±³ç™½ä¸»é¡Œï¼ˆä¼æ¥­ç°¡å ±å‹å–„ï¼‰ */
      --bg:#f6f3ee;
      --panel:#faf7f2;
      --card:#ffffff;
      --muted:#7a746b;
      --text:#2f2b26;
      --line:rgba(0,0,0,.08);
      --good:#3aa981;
      --warn:#e2a93b;
      --bad:#d96b6b;
      --accent:#c9a86a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #caf5ff 0%, #f3efe8 100%);
      color:var(--text);
      padding:24px;
    }
    .wrap{max-width:1220px;margin:0 auto}
    header{
      display:flex;gap:16px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:18px;
    }
    h1{font-size:22px;margin:0;letter-spacing:.2px}
    .sub{color:var(--muted);margin-top:6px;font-size:13px;line-height:1.5}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--line);
      border-radius:999px;background:rgba(255,255,255,.04);
      color:var(--muted);font-size:12px;
    }
    .pill label{display:inline-flex;align-items:center;gap:6px;color:var(--text);font-size:12px}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    .card .hd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background: linear-gradient(180deg, #faf7f2, #f3efe8);
    }
    .card .hd b{font-size:14px}
    .card .bd{padding:14px 16px}
    .section{margin-bottom:14px}
    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    input[type="text"], textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fffdf8;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:88px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 560px){ .row{grid-template-columns:1fr} }

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:#fffdf8;color:var(--text);font-size:12px;
      cursor:pointer; user-select:none;
      transition: transform .05s ease, background .15s ease;
    }
    .chip:active{transform:scale(.98)}
    .chip.on{
      border-color: var(--accent);
      background: rgba(201,168,106,.18);
    }

    .mini{color:var(--muted);font-size:12px;line-height:1.55}
    .risk{
      display:flex;gap:8px;align-items:flex-start;
      padding:10px 12px;border-radius:12px;border:1px dashed var(--line);
      background: rgba(255,255,255,.03);
      margin-top:10px;
    }
    .dot{width:10px;height:10px;border-radius:999px;margin-top:5px}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#fffdf8;
      color: var(--text);
      cursor:pointer;
    }
    button.primary{
      border-color: var(--accent);
      background: rgba(201,168,106,.25);
    }

    pre{
      white-space:pre-wrap;
      word-break:break-word;
      background:#fbf9f5;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      margin:0;
      color:var(--text);
      font-size:12px;
      line-height:1.5;
    }
    .kv{
      display:grid;grid-template-columns: 120px 1fr;gap:8px 10px;
      font-size:12px;color:var(--text);
    }
    .kv div:nth-child(odd){color:var(--muted)}
    .footerNote{color:var(--muted);font-size:12px;margin-top:10px}

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0; display:none;
      background:rgba(0,0,0,.55);
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(920px, 100%);
      background:#ffffff;
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: 0 24px 80px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modalHd{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .modalHd b{font-size:13px}
    .modalBd{padding:12px 14px}
    .modalBd textarea{
      width:100%; min-height:280px;
      background:#fbf9f5;
      border:1px solid var(--line);
      border-radius:12px;
      color:var(--text);
      padding:12px;
      font-size:12px;
      line-height:1.55;
    }
    .modalFt{padding:12px 14px; display:flex; gap:10px; flex-wrap:wrap; border-top:1px solid var(--line)}
    .xbtn{border:1px solid var(--line); background:rgba(255,255,255,.06); border-radius:10px; padding:8px 10px; cursor:pointer; color:var(--text)}
    .help{color:var(--muted); font-size:12px; line-height:1.55}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <h1 style="margin:0;" id="titleH1">OEMï½œåŒ…è£åå¥½å¿«é€Ÿé‡æ¸…å™¨</h1>
        <span id="headerMeta" class="pill" style="padding:6px 10px;">â€”</span>
      </div>
      <div class="sub" id="subtitle">
        çµ¦æ¥­ä¸»ç”¨çš„ã€Œé¸ä¸€é¸å°±èƒ½è¬›æ¸…æ¥šã€å·¥å…·ï¼š<br/>
        ç”¢å‡º <b>åŒ…è£åå¥½ Brief</b> ï¼‹ <b>GEMINI CANVAS Prompt</b>ï¼Œè®“ OEM ä¸€é–‹å§‹å°±å°é½Šæ–¹å‘ï¼ˆå°‘èµ°å†¤æ‰è·¯ï¼‰ã€‚
      </div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
      <div class="pill" title="åˆ‡æ›å¾Œæœƒè‡ªå‹•æ›é¡Œåº«ã€æç¤ºèªèˆ‡æ³•è¦é¢¨éšªé‚è¼¯">
        OEM é¡å‹ï¼š
        <label><input type="radio" name="oemType" value="cosmetic" checked> åŒ–å¦å“</label>
        <label style="margin-left:8px;"><input type="radio" name="oemType" value="health_food"> ä¿å¥é£Ÿå“</label>
      </div>
      <div class="pill">âœ… å¯ç›´æ¥ç™¼ä½ˆï½œğŸ“„ å¯è¤‡è£½ Markdownï½œğŸ§  è‡ªå‹•ç”Ÿ Prompt</div>
    </div>
  </header>

  <div class="grid">
    <!-- Left: Form -->
    <div class="card">
      <div class="hd">
        <b>1) æ¥­ä¸»åå¥½å¡«å¯«</b>
        <span class="mini">å°æé†’ï¼šä½ é¸çš„ä¸æ˜¯ã€Œå¥½ä¸å¥½çœ‹ã€ï¼Œè€Œæ˜¯ã€Œæœªä¾†é‡ç”¢å¾Œåƒä¸åƒä½ å¿ƒä¸­çš„å“ç‰Œã€ã€‚</span>
      </div>
      <div class="bd">

        <!-- Report Meta -->
        <div class="row">
          <div class="section">
            <label>å…¬å¸åç¨±ï¼ˆå ±å‘ŠæŠ¬é ­ï¼‰</label>
            <input id="company" type="text" placeholder="ä¾‹ï¼šå¥‡ç•°ç”ŸæŠ€è‚¡ä»½æœ‰é™å…¬å¸" value="å¥‡ç•°ç”ŸæŠ€è‚¡ä»½æœ‰é™å…¬å¸" />
          </div>
          <div class="section">
            <label>å°ˆæ¡ˆç·¨è™Ÿï¼ˆProject IDï¼‰</label>
            <input id="projectId" type="text" placeholder="ä¾‹ï¼šOEM-2025-001" />
          </div>
        </div>
        <div class="row">
          <div class="section">
            <label>å ±å‘Šæ—¥æœŸ</label>
            <input id="reportDate" type="text" placeholder="YYYY-MM-DD" />
          </div>
          <div class="section">
            <label class="mini">ï¼ˆå·²ç§»é™¤å…¬å¸ LOGOï¼‰</label>
            <div class="mini">è‹¥æœªä¾†åˆéœ€è¦ LOGOï¼Œæˆ‘å¯ä»¥ç”¨ã€Œå¯é¸é–‹é—œã€æ–¹å¼åŠ å›ä¾†ï¼Œé¿å…ç¨‹å¼å†æ¬¡æ‰“çµã€‚</div>
          </div>
        </div>

        <div class="row">
          <div class="section">
            <label>å“ç‰Œ / å°ˆæ¡ˆåç¨±</label>
            <input id="brand" type="text" placeholder="ä¾‹ï¼šå¥‡ç•°ç”ŸæŠ€ï½œN ç³»åˆ— / æŸæŸå“ç‰Œæ–°å“" />
          </div>
          <div class="section">
            <label>ç”¢å“é¡å‹</label>
            <select id="ptype"></select>
          </div>
        </div>

        <div class="row">
          <div class="section">
            <label>å“ç‰Œå®šä½ï¼ˆé¸ 1â€“2ï¼‰</label>
            <div class="chips" id="posChips"></div>
          </div>
          <div class="section">
            <label>ç›®æ¨™å®¢ç¾¤</label>
            <input id="aud" type="text" placeholder="ä¾‹ï¼š25â€“40 å¥³æ€§ï¼æ²™é¾å°ˆæ¥­äººå£«ï¼ä¸Šç­æ—ï¼éŠ€é«®æ—ç¾¤" />
          </div>
        </div>

        <div class="section">
          <label>é€šè·¯ï¼ˆé¸ 1â€“2ï¼‰</label>
          <div class="chips" id="channelChips"></div>
        </div>

        <div class="row">
          <div class="section">
            <label>åŒ…è£å½¢å¼ï¼ˆé¸ 1â€“2ï¼‰</label>
            <div class="chips" id="packChips"></div>
          </div>
          <div class="section">
            <label>æè³ªåå¥½ï¼ˆé¸ 1â€“2ï¼‰</label>
            <div class="chips" id="matChips"></div>
          </div>
        </div>

        <div class="row">
          <div class="section">
            <label>è‰²ç³»åå¥½ï¼ˆå¯è¤‡é¸ï¼‰</label>
            <div class="chips" id="colorChips"></div>
          </div>
          <div class="section">
            <label>è³ªæ„Ÿèˆ‡æ°›åœï¼ˆé¸ 2â€“4ï¼‰</label>
            <div class="chips" id="moodChips"></div>
          </div>
        </div>

        <div class="row">
          <div class="section">
            <label>å­—é«” / æ’ç‰ˆé¢¨æ ¼ï¼ˆé¸ 1â€“2ï¼‰</label>
            <div class="chips" id="typeChips"></div>
          </div>
          <div class="section">
            <label>åœ–åƒèªè¨€ï¼ˆé¸ 1â€“2ï¼‰</label>
            <div class="chips" id="visualChips"></div>
          </div>
        </div>

        <div class="row">
          <div class="section">
            <label>ä½ æƒ³é¿å…çš„é¢¨æ ¼ï¼ˆé¸ 1â€“3ï¼‰</label>
            <div class="chips" id="avoidChips"></div>
          </div>
          <div class="section">
            <label id="ingLabel">æˆåˆ† / ç§‘æŠ€å½¢è±¡ï¼ˆå¯å¡«ï¼‰</label>
            <input id="ing" type="text" placeholder="ä¾‹ï¼šæ¤èƒã€èƒœè‚½ï¼ˆæ³¨æ„åˆè¦ï¼‰" />
          </div>
        </div>

        <div class="section">
          <label>è£œå……å‚™è¨»ï¼ˆæ¥­ä¸»è‡ªç”±æè¿°ï¼‰</label>
          <textarea id="note" placeholder="ä¾‹ï¼šå¸Œæœ›æ›´åƒé†«ç¾è¨ºæ‰€çš„ä¿¡ä»»æ„Ÿï¼Œä½†ä¸è¦é†«ç™‚å™¨æ¢°æ„Ÿï¼›é¿å…éåº¦å°‘å¥³ï¼›å–œæ­¡ç•™ç™½èˆ‡éœ§é¢æè³ªã€‚"></textarea>
        </div>

        <div class="btns">
          <button class="primary" id="btnSample">å¥—ç”¨ç¤ºç¯„</button>
          <button id="btnReset">æ¸…ç©ºé‡å¡«</button>
          <button class="primary" id="btnCopyMd">è¤‡è£½ Markdown å ±å‘Š</button>
          <button id="btnCopyPrompt">è¤‡è£½ GEMINI Prompt</button>
        </div>

        <div class="footerNote" id="footerNote">
          ğŸ˜„ å‹æƒ…æé†’ï¼šå¦‚æœä½ åŒæ™‚å‹¾é¸ã€Œé»‘é‡‘å¥¢è¯ã€åˆå‹¾ã€Œè¦ªæ°‘å¯æ„›ã€ï¼Œé‚£ä¸æ˜¯å“ç‰Œå®šä½ï¼Œé‚£æ˜¯äººæ ¼åˆ†è£‚â€”â€”å³å´æœƒæé†’ä½ å…ˆåšæ±ºç­–æ”¶æ–‚ã€‚
        </div>
      </div>
    </div>

    <!-- Right: Outputs -->
    <div class="card">
      <div class="hd">
        <b>2) ç”¢å‡ºï¼ˆå¯ç›´æ¥äº¤ä»˜ï¼‰</b>
        <span class="mini">å³æ™‚æ›´æ–°ï¼šBrief æ‘˜è¦ + ä¸€è‡´æ€§æé†’ + æ³•è¦é¢¨éšªç´…é»ƒç¶ ç‡ˆ + GEMINI Prompt</span>
      </div>
      <div class="bd">

        <div class="section">
          <label>åŒ…è£åå¥½æ‘˜è¦ï¼ˆçµ¦æ±ºç­–è€… / å·¥å»  / è¨­è¨ˆï¼‰</label>
          <div class="kv" id="briefKv"></div>

          <div class="risk" id="riskBox">
            <div class="dot good" id="riskDot"></div>
            <div>
              <div style="font-size:12px;margin-bottom:4px;"><b id="riskTitle">ä¸€è‡´æ€§é¢¨éšªï¼šè‰¯å¥½</b></div>
              <div class="mini" id="riskMsg">ç›®å‰é¸é …æ•´é«”ä¸€è‡´ï¼Œé©åˆç›´æ¥é€²å…¥è¦–è¦ºææ¡ˆã€‚</div>
            </div>
          </div>

          <div class="risk" id="lawBox">
            <div class="dot good" id="lawDot"></div>
            <div>
              <div style="font-size:12px;margin-bottom:4px;"><b id="lawTitle">æ³•è¦é¢¨éšªï¼šä½ï¼ˆç¶ ç‡ˆï¼‰</b></div>
              <div class="mini" id="lawMsg">ç›®å‰ç”¨èªèˆ‡æ–¹å‘ç›¸å°ä¿å®ˆï¼›ä»å»ºè­°é€²å…¥å…§éƒ¨åˆè¦å¯©æŸ¥æµç¨‹ã€‚</div>
            </div>
          </div>
        </div>

        <div class="section">
          <label>GEMINI CANVAS Promptï¼ˆå¯ç›´æ¥è²¼ï¼‰</label>
          <pre id="promptOut"></pre>
        </div>

        <div class="section">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <label>Markdown å ±å‘Šé è¦½</label>
            <button id="btnCopyMdInline" class="primary" style="padding:6px 10px;font-size:12px;">è¤‡è£½</button>
          </div>
          <pre id="mdOut"></pre>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- Modal (fallback for copy restrictions) -->
<div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modalHd">
      <b id="modalTitle">è¼¸å‡ºå…§å®¹</b>
      <button class="xbtn" id="modalClose">é—œé–‰</button>
    </div>
    <div class="modalBd">
      <div class="help" id="modalHelp" style="margin-bottom:10px;">è‹¥ç€è¦½å™¨é™åˆ¶å‰ªè²¼ç°¿ï¼Œè«‹åœ¨æ­¤æ‰‹å‹•è¤‡è£½ã€‚</div>
      <textarea id="modalText" spellcheck="false"></textarea>
    </div>
    <div class="modalFt">
      <button class="primary" id="modalCopy">ä¸€éµè¤‡è£½ï¼ˆå‚™æ´ï¼‰</button>
      <button id="modalSelect">å…¨é¸</button>
    </div>
  </div>
</div>

<script>
"use strict";

let oemType = "cosmetic"; // "cosmetic" | "health_food"

function formatDateYYYYMMDD(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function updateHeaderMeta(){
  const company = (document.getElementById("company")?.value || "").trim();
  const pid = (document.getElementById("projectId")?.value || "").trim();
  const dt = (document.getElementById("reportDate")?.value || "").trim();
  const typeLabel = (oemType === "cosmetic") ? "åŒ–å¦å“" : "ä¿å¥é£Ÿå“";
  const meta = [typeLabel, company, pid ? `#${pid}` : "", dt].filter(Boolean).join(" Â· ");
  const metaEl = document.getElementById("headerMeta");
  if(metaEl) metaEl.textContent = meta || "â€”";
}

function getTypeLabels(){
  if(oemType === "cosmetic"){
    return {
      title: "åŒ–å¦å“ OEMï½œåŒ…è£åå¥½å¿«é€Ÿé‡æ¸…å™¨",
      subtitle: "çµ¦æ¥­ä¸»ç”¨çš„ã€Œé¸ä¸€é¸å°±èƒ½è¬›æ¸…æ¥šã€å·¥å…·ï¼š\nç”¢å‡º åŒ…è£åå¥½ Brief ï¼‹ GEMINI CANVAS Promptï¼Œè®“ OEM ä¸€é–‹å§‹å°±å°é½Šæ–¹å‘ï¼ˆå°‘èµ°å†¤æ‰è·¯ï¼‰ã€‚",
      ingLabel: "æˆåˆ† / ç§‘æŠ€å½¢è±¡ï¼ˆå¯å¡«ï¼‰",
      ingPlaceholder: "ä¾‹ï¼šæ¤èƒã€èƒœè‚½ï¼ˆæ³¨æ„åˆè¦ï¼‰",
      sampleName: "å¥—ç”¨ç¤ºç¯„ï¼ˆæ²™é¾é«˜ç«¯ï¼‰"
    };
  }
  return {
    title: "ä¿å¥é£Ÿå“ OEMï½œç”¢å“èˆ‡åŒ…è£æ–¹å‘å¿«é€Ÿé‡æ¸…å™¨",
    subtitle: "çµ¦æ¥­ä¸»ç”¨çš„ã€Œé¸ä¸€é¸å°±èƒ½èªªæ¸…æ¥šã€å·¥å…·ï¼š\nç”¢å‡º ç”¢å“æ–¹å‘ Brief ï¼‹ åŒ…è£é‡é» ï¼‹ æ³•è¦é¢¨éšªç´…é»ƒç¶ ç‡ˆï¼Œè®“ OEM åœ¨æ‰“æ¨£/ä¸Šæ¶å‰å…ˆå°é½Šï¼ˆé™ä½è¿”å·¥ï¼‰ã€‚",
    ingLabel: "ä¸»æˆåˆ† / æ©Ÿèƒ½è¨´æ±‚ï¼ˆå°‡å½±éŸ¿æ¨™ç¤ºèˆ‡åˆè¦ï¼‰",
    ingPlaceholder: "ä¾‹ï¼šè‘‰é»ƒç´ ã€ç›Šç”ŸèŒã€è† åŸè›‹ç™½ï¼ˆé¿å…æ²»ç™‚/ç–¾ç—…æš—ç¤ºï¼‰",
    sampleName: "å¥—ç”¨ç¤ºç¯„ï¼ˆä¸Šç­æ—æ©Ÿèƒ½ï¼‰"
  };
}

function applyTypeLabels(){
  const labels = getTypeLabels();
  document.getElementById("titleH1").textContent = labels.title;

  const subtitle = document.getElementById("subtitle");
  subtitle.innerHTML = labels.subtitle.replaceAll("\n", "<br/>");

  document.getElementById("ingLabel").textContent = labels.ingLabel;
  document.getElementById("ing").placeholder = labels.ingPlaceholder;
  document.getElementById("btnSample").textContent = labels.sampleName;
}

function makeChips(containerId, items){
  const el = document.getElementById(containerId);
  if(!el) return;
  el.innerHTML = "";
  items.forEach(txt=>{
    const c = document.createElement("div");
    c.className = "chip";
    c.textContent = txt;
    c.onclick = ()=>{ c.classList.toggle("on"); updateAll(); };
    el.appendChild(c);
  });
}

function getSelected(containerId){
  return [...document.querySelectorAll(`#${containerId} .chip.on`)].map(x=>x.textContent);
}

function setSelected(containerId, arr){
  document.querySelectorAll(`#${containerId} .chip`).forEach(ch=>{
    ch.classList.toggle("on", arr.includes(ch.textContent));
  });
}

function kvRow(k,v){
  const d1 = document.createElement("div"); d1.textContent = k;
  const d2 = document.createElement("div"); d2.textContent = v || "â€”";
  return [d1,d2];
}

// ---------- Data (by OEM type) ----------
const baseCfg = {
  mat: ["éœ§é¢å¡‘æ–™","é€æ˜å¡‘æ–™","ç»ç’ƒ","éœ§é¢ç»ç’ƒ","é‡‘å±¬è³ªæ„Ÿï¼ˆå±€éƒ¨ï¼‰","ç´™ç›’å¤–åŒ…è£","ç’°ä¿æè³ªæ„Ÿ"],
  color: ["è±¡ç‰™ç™½","éœ§é‡‘","é»‘é‡‘","ç±³ç™½","æ·¡ç¶ ","æ·¡é»ƒ","éœ§ç°","æ·±è—","ç«ç‘°é‡‘","è£¸ç²‰","é€æ˜æ„Ÿ"],
  mood: ["å°ˆæ¥­å¯ä¿¡","ä¹¾æ·¨ç´”æ·¨","æº«æŸ”è¦ªè†š","ä½èª¿å¥¢è¯","è‡ªç„¶æ¸…æ–°","ç†æ€§å…‹åˆ¶","é«˜ç´šæ„Ÿ","ç™‚ç™’æ„Ÿ","æœ‰åŠ›é‡ï¼ˆä½†ä¸ä¾µç•¥ï¼‰"],
  type: ["ç¾ä»£ç„¡è¥¯ç·š","ç´°å­—æ¥µç°¡","é«˜ç´šè¥¯ç·š","ç†æ€§æ ¼ç·šæ’ç‰ˆ","å¤§ç•™ç™½ï¼‹å°å­—","è³‡è¨Šæ¸…æ™°å°å‘"],
  visual: ["æŠ½è±¡å…‰æ„Ÿ","ç·šæ¢æµå‹•","æ¤ç‰©æ„è±¡ï¼ˆæŠ½è±¡ï¼‰","å¹¾ä½•ç§‘æŠ€æ„Ÿï¼ˆä½èª¿ï¼‰","æ°´æ„Ÿé€æ˜å±¤æ¬¡","ç„¡åœ–åƒï¼ˆç´”æ’ç‰ˆï¼‰"],
  avoid: ["éåº¦é†«ç™‚å™¨æ¢°æ„Ÿ","éåº¦ä¿ƒéŠ·é›»å•†æ„Ÿ","éåº¦å°‘å¥³å¯æ„›","å¤ªèŠ±å¤ªæ»¿","å»‰åƒ¹é‡‘å…‰é–ƒäº®","å¼·çƒˆå°æ¯”åˆºçœ¼"]
};

const cfgByType = {
  cosmetic: {
    pos: ["é†«ç¾å‹å–„ï¼ˆéé†«ç™‚ï¼‰","æ²™é¾å°ˆæ¥­","é«˜ç«¯ç²¾å“","æº«å’Œæ•å¼±","è‡ªç„¶æ¤èƒ","ç§‘æŠ€æ„Ÿï¼ˆå…‹åˆ¶ï¼‰","è¦ªæ°‘æ—¥å¸¸","æ¥µç°¡ç•™ç™½"],
    channel: ["æ²™é¾ B2B","å®˜ç¶²é›»å•†","é†«ç¾è¨ºæ‰€é€šè·¯","è—¥å±€ / é€šè·¯","ç›´æ’­åœ˜è³¼","ç™¾è²¨å°ˆæ«ƒ"],
    pack: ["åœ“ç“¶","æ–¹ç“¶","æ»´ç®¡","æŒ‰å£“ç“¶","å™´éœ§","å®‰ç“¶","è»Ÿç®¡","ç½è£"],
    ptype: ["æ´—é«®ç²¾","è­·é«® / é«®è†œ","é ­çš®ç²¾è¯","å®‰ç“¶","è‡‰éƒ¨ç²¾è¯","é¢éœœ","åŒ–å¦æ°´","å¸å¦ / æ¸…æ½”","é˜²æ›¬","èº«é«”ä¹³"]
  },
  health_food: {
    pos: ["å°ˆæ¥­ä¿å¥å“ç‰Œ","æ—¥å¸¸è£œå……å‹","æ©Ÿèƒ½è¨´æ±‚å°å‘","é«˜ç«¯é€ç¦®å¸‚å ´","å®¶åº­å¸¸å‚™å‹","éŠ€é«®å‹å–„","ä¸Šç­æ—æ©Ÿèƒ½è£œçµ¦","æ¥µç°¡ç•™ç™½"],
    channel: ["å®˜ç¶²é›»å•†","è—¥å±€ / è—¥å¦é€šè·¯","è¨ºæ‰€ / å°ˆæ¥­é€šè·¯","åœ˜è³¼ / ç¤¾ç¾¤åˆ†æ½¤","ç›´éŠ· / æœƒå“¡åˆ¶","è·¨å¢ƒé›»å•†"],
    pack: ["é‹ç®”è¢‹","PTP é‹ç®”åŒ…","ç»ç’ƒç“¶","å¡‘è† ç“¶","éš¨èº«æ¢åŒ…","ç¦®ç›’çµ„"],
    ptype: ["è† å›Š","éŒ åŠ‘","ç²‰åŒ…","æ¶²æ…‹é£²","æ»´åŠ‘","æ©Ÿèƒ½è»Ÿç³–","æ²–æ³¡é£²","è¤‡æ–¹æ©Ÿèƒ½é…æ–¹"]
  }
};

function updatePtypeOptions(){
  const select = document.getElementById("ptype");
  if(!select) return;
  select.innerHTML = "";
  cfgByType[oemType].ptype.forEach(t=>{
    const opt = document.createElement("option");
    opt.textContent = t;
    select.appendChild(opt);
  });
}

function applyOEMMode(){
  applyTypeLabels();

  const cfg = cfgByType[oemType];
  makeChips("posChips", cfg.pos);
  makeChips("channelChips", cfg.channel);
  makeChips("packChips", cfg.pack);

  // shared chips
  makeChips("matChips", baseCfg.mat);
  makeChips("colorChips", baseCfg.color);
  makeChips("moodChips", baseCfg.mood);
  makeChips("typeChips", baseCfg.type);
  makeChips("visualChips", baseCfg.visual);
  makeChips("avoidChips", baseCfg.avoid);

  updatePtypeOptions();
}

// ---------- Risk: consistency (style) ----------
function evaluateRiskConsistency(sel){
  let score = 0;
  const warns = [];
  const has = (arr, key) => Array.isArray(arr) && arr.includes(key);

  if (has(sel.mood,"ä½èª¿å¥¢è¯") && has(sel.pos,"è¦ªæ°‘æ—¥å¸¸")) { score+=2; warns.push("åŒæ™‚é¸åˆ°ã€Œä½èª¿å¥¢è¯ã€èˆ‡ã€Œè¦ªæ°‘æ—¥å¸¸ã€ï¼Œå»ºè­°å…ˆæ±ºå®šåƒ¹æ ¼å¸¶èˆ‡é€šè·¯èªè¨€ã€‚"); }
  if (has(sel.color,"é»‘é‡‘") && !has(sel.avoid,"å»‰åƒ¹é‡‘å…‰é–ƒäº®") && has(sel.mood,"ä½èª¿å¥¢è¯")) { score+=1; warns.push("é»‘é‡‘åšå¾—å¥½æ˜¯ç²¾å“ï¼›åšä¸å¥½å°±æ˜¯KTVã€‚å»ºè­°é–å®šã€éœ§é‡‘ï¼‹ç•™ç™½ã€ï¼Œé¿å…äº®é¢å¤§é¢ç©é‡‘è‰²ã€‚"); }
  if (has(sel.pos,"ç§‘æŠ€æ„Ÿï¼ˆå…‹åˆ¶ï¼‰") && has(sel.mood,"è‡ªç„¶æ¸…æ–°")) { score+=1; warns.push("ç§‘æŠ€æ„Ÿèˆ‡è‡ªç„¶æ„Ÿå¯ä»¥å…±å­˜ï¼Œä½†éœ€è¦ã€æŠ½è±¡æ¤ç‰©ï¼‹ç†æ€§æ’ç‰ˆã€ä¾†å¹³è¡¡ã€‚"); }

  if (oemType === "health_food" && has(sel.pos,"é«˜ç«¯é€ç¦®å¸‚å ´") && has(sel.channel,"åœ˜è³¼ / ç¤¾ç¾¤åˆ†æ½¤")) {
    score+=1; warns.push("é€ç¦®é«˜ç«¯èˆ‡åœ˜è³¼èªè¨€å¯å…±å­˜ï¼Œä½†åŒ…è£å¿…é ˆèµ°ã€ç¦®ç›’æ„Ÿã€ï¼Œä¸¦é¿å…éåº¦ä¿ƒéŠ·è¦–è¦ºã€‚");
  }

  let level = "good";
  if (score >= 4) level = "bad";
  else if (score >= 2) level = "warn";

  return {score, level, warns};
}

// ---------- Risk: regulation traffic light ----------
const regulationKeywords = {
  cosmetic: {
    high: ["æ²»ç™‚","é†«ç™‚","ç™‚æ•ˆ","å¤–æ³Œé«”","å¹¹ç´°èƒ","stem cell","exosome"],
    mid: ["ä¿®å¾©","å†ç”Ÿ","æŠ—è€","æ”¹å–„ç–¾ç—…","é é˜²"]
  },
  health_food: {
    high: ["æ²»ç™‚","æ”¹å–„ç–¾ç—…","é é˜²","ç™‚æ•ˆ","é†«å¸«æ¨è–¦","è—¥æ•ˆ","è™•æ–¹","diagnose","cure"],
    mid: ["æ”¹å–„","æŠ—è€","ä¿®å¾©","æ´»åŒ–","èª¿æ•´","å»¶ç·©è€åŒ–","æ¸›å°‘ç–¼ç—›","æ¶ˆç‚"]
  }
};

function evaluateRegulationRisk(text){
  const t = (text || "").toLowerCase();
  const dict = regulationKeywords[oemType];
  let score = 0;
  const hitsHigh = [];
  const hitsMid = [];

  dict.high.forEach(k=>{
    if(t.includes(k.toLowerCase())){ score += 3; hitsHigh.push(k); }
  });
  dict.mid.forEach(k=>{
    if(t.includes(k.toLowerCase())){ score += 1; hitsMid.push(k); }
  });

  let level = "green";
  if(score >= 5) level = "red";
  else if(score >= 2) level = "yellow";

  const note = [];
  if(hitsHigh.length) note.push(`é«˜é¢¨éšªè©ï¼š${hitsHigh.join("ã€")}`);
  if(hitsMid.length) note.push(`æ³¨æ„è©ï¼š${hitsMid.join("ã€")}`);

  return {level, score, note};
}

function updateRegulationUI(reg){
  const dot = document.getElementById("lawDot");
  const title = document.getElementById("lawTitle");
  const msg = document.getElementById("lawMsg");

  if(reg.level === "green"){
    dot.className = "dot good";
    title.textContent = "æ³•è¦é¢¨éšªï¼šä½ï¼ˆç¶ ç‡ˆï¼‰";
    msg.textContent = "ç›®å‰ç”¨èªèˆ‡æ–¹å‘ç›¸å°ä¿å®ˆï¼›ä»å»ºè­°é€²å…¥å…§éƒ¨åˆè¦å¯©æŸ¥æµç¨‹ã€‚";
  } else if(reg.level === "yellow") {
    dot.className = "dot warn";
    title.textContent = "æ³•è¦é¢¨éšªï¼šä¸­ï¼ˆé»ƒç‡ˆï½œéœ€èª¿æ•´ï¼‰";
    msg.textContent = (reg.note[0] || "éƒ¨åˆ†ç”¨èªå¯èƒ½è¸©ç·šï¼Œå»ºè­°å…ˆæ”¹å¯«æˆæ›´ä¿å®ˆçš„æè¿°ï¼Œå†é€²å…¥é‡ç”¢ã€‚");
  } else {
    dot.className = "dot bad";
    title.textContent = "æ³•è¦é¢¨éšªï¼šé«˜ï¼ˆç´…ç‡ˆï½œä¸å»ºè­°ï¼‰";
    msg.textContent = (reg.note[0] || "ç›®å‰è¨­å®šæ¥µå¯èƒ½è¸©æ³•è¦æˆ–è¢«åˆ¤å®šèª‡å¤§ï¼é†«ç™‚æš—ç¤ºï¼Œè«‹å…ˆåšåˆè¦ä¿®æ­£ã€‚");
  }
}

// ---------- Builders ----------
function collect(){
  return {
    company: (document.getElementById("company")?.value || "").trim(),
    projectId: (document.getElementById("projectId")?.value || "").trim(),
    reportDate: (document.getElementById("reportDate")?.value || "").trim(),
    brand: (document.getElementById("brand")?.value || "").trim(),
    ptype: (document.getElementById("ptype")?.value || "").trim(),
    aud: (document.getElementById("aud")?.value || "").trim(),
    ing: (document.getElementById("ing")?.value || "").trim(),
    note: (document.getElementById("note")?.value || "").trim(),
    pos: getSelected("posChips"),
    channel: getSelected("channelChips"),
    pack: getSelected("packChips"),
    mat: getSelected("matChips"),
    color: getSelected("colorChips"),
    mood: getSelected("moodChips"),
    type: getSelected("typeChips"),
    visual: getSelected("visualChips"),
    avoid: getSelected("avoidChips"),
  };
}

function buildPrompt(sel){
  const pos = sel.pos.join("ã€") || "ï¼ˆæœªé¸ï¼‰";
  const channel = sel.channel.join("ã€") || "ï¼ˆæœªé¸ï¼‰";
  const pack = sel.pack.join("ã€") || "ï¼ˆæœªé¸ï¼‰";
  const mat = sel.mat.join("ã€") || "ï¼ˆæœªé¸ï¼‰";
  const color = sel.color.join("ã€") || "ï¼ˆæœªé¸ï¼‰";
  const mood = sel.mood.join("ã€") || "ï¼ˆæœªé¸ï¼‰";
  const type = sel.type.join("ã€") || "ï¼ˆæœªé¸ï¼‰";
  const visual = sel.visual.join("ã€") || "ï¼ˆæœªé¸ï¼‰";
  const avoid = sel.avoid.join("ã€") || "ï¼ˆæœªé¸ï¼‰";

  const baseMeta =
`ï¼ˆå…§éƒ¨å ±å‘Šè³‡è¨Šï¼‰
å…¬å¸ï¼š${sel.company || "ï¼ˆæœªå¡«ï¼‰"}
å°ˆæ¡ˆç·¨è™Ÿï¼š${sel.projectId || "ï¼ˆæœªå¡«ï¼‰"}
æ—¥æœŸï¼š${sel.reportDate || "ï¼ˆæœªå¡«ï¼‰"}

`;

  if(oemType === "cosmetic"){
    return baseMeta +
`è«‹ç”Ÿæˆä¸€çµ„ã€ŒåŒ–å¦å“ OEM åŒ…è£è¦–è¦ºæ–¹å‘ã€ä½œç‚ºè¨­è¨ˆææ¡ˆåƒè€ƒï¼ˆéæ’ç•«ã€éœ€å…·é‡ç”¢å¯è¡Œæ„Ÿï¼‰ã€‚

ã€åŸºæœ¬è³‡æ–™ã€‘
å“ç‰Œ/å°ˆæ¡ˆï¼š${sel.brand || "ï¼ˆæœªå¡«ï¼‰"}
ç”¢å“é¡å‹ï¼š${sel.ptype}
ç›®æ¨™å®¢ç¾¤ï¼š${sel.aud || "ï¼ˆæœªå¡«ï¼‰"}
é€šè·¯ï¼š${channel}
å“ç‰Œå®šä½ï¼š${pos}

ã€åŒ…è£åå¥½ã€‘
åŒ…è£å½¢å¼ï¼š${pack}
æè³ªåå¥½ï¼š${mat}
è‰²ç³»åå¥½ï¼š${color}
è³ªæ„Ÿ/æ°›åœï¼š${mood}
å­—é«”/æ’ç‰ˆï¼š${type}
åœ–åƒèªè¨€ï¼š${visual}

ã€æƒ³é¿å…çš„é¢¨æ ¼ã€‘
${avoid}

ã€æˆåˆ†/ç§‘æŠ€å½¢è±¡ï¼ˆå¦‚éœ€ï¼‰ã€‘
${sel.ing || "ï¼ˆæœªå¡«ï¼‰"}

ã€è£œå……å‚™è¨»ã€‘
${sel.note || "ï¼ˆæœªå¡«ï¼‰"}

ã€ç¡¬æ€§è¦ç¯„ã€‘
- è¦–è¦ºéœ€å‘ˆç¾å°ˆæ¥­ã€ä¹¾æ·¨ã€å¯ä¿¡ä»»
- é¿å…é†«ç™‚å™¨æ¢°æ„Ÿã€æ²»ç™‚æš—ç¤ºã€ç™‚æ•ˆèª‡å¼µ
- å¯ç›´æ¥ç”¨æ–¼ OEM ææ¡ˆèˆ‡è¨­è¨ˆ brief å°é½Š
- ä»¥å•†æ¥­ç”¢å“æ”å½±/åŒ…è£è¨­è¨ˆèªè¨€å‘ˆç¾ï¼šæ¸…æ™°æ¯”ä¾‹ã€åˆç†æè³ªã€å¯é‡ç”¢å°åˆ·æ„Ÿ`;
  }

  return baseMeta +
`è«‹ç”Ÿæˆä¸€çµ„ã€Œä¿å¥é£Ÿå“ OEM ç”¢å“èˆ‡åŒ…è£æ–¹å‘ã€ä½œç‚ºææ¡ˆåƒè€ƒã€‚

ã€åˆè¦èªå¢ƒã€‘
- ä»¥å°ç£é£Ÿå“æ³•è¦èªå¢ƒæ’°å¯«
- é¿å…é†«ç™‚ã€æ²»ç™‚ã€ç–¾ç—…é é˜²ã€èª‡å¤§ç™‚æ•ˆæš—ç¤º
- å¼·èª¿é•·æœŸè£œå……ã€æ—¥å¸¸ä¿é¤Šã€å®‰å¿ƒå¯è¿½æº¯

ã€åŸºæœ¬è³‡æ–™ã€‘
å“ç‰Œ/å°ˆæ¡ˆï¼š${sel.brand || "ï¼ˆæœªå¡«ï¼‰"}
åŠ‘å‹/ç”¢å“é¡å‹ï¼š${sel.ptype}
ç›®æ¨™æ—ç¾¤ï¼š${sel.aud || "ï¼ˆæœªå¡«ï¼‰"}
é€šè·¯ï¼š${channel}
å“ç‰Œå®šä½ï¼š${pos}

ã€åŒ…è£æ–¹å‘ã€‘
åŒ…è£å½¢å¼ï¼š${pack}
æè³ªåå¥½ï¼š${mat}
è‰²ç³»åå¥½ï¼š${color}
è³ªæ„Ÿ/æ°›åœï¼š${mood}
å­—é«”/æ’ç‰ˆï¼š${type}ï¼ˆè³‡è¨Šå¯è®€æ€§å„ªå…ˆï¼‰
åœ–åƒèªè¨€ï¼š${visual}

ã€æƒ³é¿å…çš„é¢¨æ ¼ã€‘
${avoid}

ã€ä¸»æˆåˆ†/æ©Ÿèƒ½è¨´æ±‚ï¼ˆåˆè¦ç”¨èªï¼‰ã€‘
${sel.ing || "ï¼ˆæœªå¡«ï¼‰"}

ã€è£œå……å‚™è¨»ã€‘
${sel.note || "ï¼ˆæœªå¡«ï¼‰"}

ã€ç¡¬æ€§è¦ç¯„ã€‘
- è¦–è¦ºéœ€å‘ˆç¾å°ˆæ¥­ã€å®‰å¿ƒã€å¯é•·æœŸè£œå……
- åŒ…è£éœ€é ç•™ç‡Ÿé¤Šæ¨™ç¤º/æˆåˆ†è³‡è¨Šç‰ˆé¢ï¼ˆå¯è®€æ€§ï¼‰
- é¿å…è—¥å“è¦–è¦ºã€é†«å¸«èƒŒæ›¸æš—ç¤ºã€ç—…ç—‡ç”¨èª
- å¯ç›´æ¥ç”¨æ–¼ OEM ææ¡ˆèˆ‡åŒ…è£ brief å°é½Šï¼ˆå¯é‡ç”¢å°åˆ·æ„Ÿï¼‰`;
}

function bullets(arr){ return arr.length ? arr.map(x=>`- ${x}`).join("\n") : "- â€”"; }

function buildMarkdown(sel, consistency, reg){
  const typeTitle = (oemType === "cosmetic") ? "åŒ–å¦å“ OEM" : "ä¿å¥é£Ÿå“ OEM";
  const warns = consistency.warns.length ? consistency.warns.map(w=>`- âš ï¸ ${w}`).join("\n") : "- âœ… ç›®å‰ç„¡æ˜é¡¯è¡çª";
  const regLine = (reg.level === "green") ? "ğŸŸ¢ ä½ï¼ˆç¶ ç‡ˆï¼‰" : (reg.level === "yellow") ? "ğŸŸ¡ ä¸­ï¼ˆé»ƒç‡ˆï¼‰" : "ğŸ”´ é«˜ï¼ˆç´…ç‡ˆï¼‰";
  const regNote = reg.note.length ? reg.note.map(x=>`- ${x}`).join("\n") : "- â€”";

  return `# ${typeTitle}ï½œåå¥½ Briefï¼ˆæ¥­ä¸»å¡«å¯«ç‰ˆï¼‰

**å…¬å¸**ï¼š${sel.company || "â€”"}  
**å°ˆæ¡ˆç·¨è™Ÿ**ï¼š${sel.projectId || "â€”"}  
**æ—¥æœŸ**ï¼š${sel.reportDate || "â€”"}  

---

**å“ç‰Œ/å°ˆæ¡ˆ**ï¼š${sel.brand || "â€”"}  
**ç”¢å“é¡å‹**ï¼š${sel.ptype}  
**ç›®æ¨™å®¢ç¾¤**ï¼š${sel.aud || "â€”"}  

## 1) å®šä½èˆ‡é€šè·¯
**å“ç‰Œå®šä½**  
${bullets(sel.pos)}

**é€šè·¯**  
${bullets(sel.channel)}

## 2) åŒ…è£åå¥½
**åŒ…è£å½¢å¼**  
${bullets(sel.pack)}

**æè³ªåå¥½**  
${bullets(sel.mat)}

**è‰²ç³»åå¥½**  
${bullets(sel.color)}

**è³ªæ„Ÿ/æ°›åœ**  
${bullets(sel.mood)}

**å­—é«”/æ’ç‰ˆ**  
${bullets(sel.type)}

**åœ–åƒèªè¨€**  
${bullets(sel.visual)}

## 3) é¿å…é …
${bullets(sel.avoid)}

## 4) æˆåˆ†/è¨´æ±‚ï¼ˆåˆè¦ç”¨èªï¼‰
${sel.ing || "â€”"}

## 5) è£œå……å‚™è¨»
${sel.note || "â€”"}

---

## 6) é¢¨éšªæé†’
**ä¸€è‡´æ€§é¢¨éšª**
${warns}

**æ³•è¦é¢¨éšªç­‰ç´š**ï¼š${regLine}
${regNote}

---

## 7) GEMINI CANVAS Prompt
\`\`\`
${buildPrompt(sel).trim()}
\`\`\`
`;
}

function updateAll(){
  const sel = collect();

  // brief kv
  const kv = document.getElementById("briefKv");
  kv.innerHTML = "";
  const items = [
    ["OEM é¡å‹", (oemType === "cosmetic") ? "åŒ–å¦å“" : "ä¿å¥é£Ÿå“"],
    ["å…¬å¸", sel.company],
    ["å°ˆæ¡ˆç·¨è™Ÿ", sel.projectId],
    ["æ—¥æœŸ", sel.reportDate],
    ["å“ç‰Œ/å°ˆæ¡ˆ", sel.brand],
    ["ç”¢å“é¡å‹", sel.ptype],
    ["ç›®æ¨™å®¢ç¾¤", sel.aud],
    ["é€šè·¯", sel.channel.join("ã€")],
    ["å®šä½", sel.pos.join("ã€")],
    ["åŒ…è£å½¢å¼", sel.pack.join("ã€")],
    ["æè³ª", sel.mat.join("ã€")],
    ["è‰²ç³»", sel.color.join("ã€")],
    ["æ°›åœ", sel.mood.join("ã€")],
    ["å­—é«”/æ’ç‰ˆ", sel.type.join("ã€")],
    ["åœ–åƒèªè¨€", sel.visual.join("ã€")],
    ["é¿å…é …", sel.avoid.join("ã€")],
    ["æˆåˆ†/è¨´æ±‚", sel.ing],
  ];
  items.forEach(([k,v])=>{
    kv.append(...kvRow(k, v));
  });

  // consistency risk
  const consistency = evaluateRiskConsistency(sel);
  const rdot = document.getElementById("riskDot");
  const rtitle = document.getElementById("riskTitle");
  const rmsg = document.getElementById("riskMsg");
  rdot.className = "dot " + consistency.level;
  if(consistency.level === "good"){
    rtitle.textContent = "ä¸€è‡´æ€§é¢¨éšªï¼šè‰¯å¥½ï¼ˆå¯é€²å…¥ææ¡ˆï¼‰";
    rmsg.textContent = "é¸é …æ•´é«”ä¸€è‡´ï¼›å¯ç”¨å³å´ Prompt ç›´æ¥ç”¢å‡ºæ–¹å‘åœ–ã€‚";
  } else if(consistency.level === "warn") {
    rtitle.textContent = "ä¸€è‡´æ€§é¢¨éšªï¼šéœ€å°é½Šï¼ˆå»ºè­°æ”¶æ–‚ï¼‰";
    rmsg.textContent = consistency.warns[0] || "éƒ¨åˆ†é¸é …å¯èƒ½äº’æ–¥ï¼Œå»ºè­°å…ˆç¢ºå®šå®šä½èˆ‡é€šè·¯èªè¨€ã€‚";
  } else {
    rtitle.textContent = "ä¸€è‡´æ€§é¢¨éšªï¼šé«˜ï¼ˆå¾ˆå¯èƒ½è¿”å·¥ï¼‰";
    rmsg.textContent = consistency.warns[0] || "ç›®å‰é¸é …è¡çªè¼ƒå¤šï¼Œå»ºè­°å…ˆåšå®šä½æ±ºç­–å†é€²å…¥è¨­è¨ˆã€‚";
  }

  // regulation risk
  const reg = evaluateRegulationRisk((sel.ing || "") + " " + (sel.note || ""));
  updateRegulationUI(reg);

  // outputs
  document.getElementById("promptOut").textContent = buildPrompt(sel).trim();
  document.getElementById("mdOut").textContent = buildMarkdown(sel, consistency, reg).trim();

  updateHeaderMeta();
}

// ---------- Modal helpers (fallback) ----------
const overlay = document.getElementById("modalOverlay");
const modalTitle = document.getElementById("modalTitle");
const modalHelp = document.getElementById("modalHelp");
const modalText = document.getElementById("modalText");
const modalClose = document.getElementById("modalClose");
const modalCopy = document.getElementById("modalCopy");
const modalSelect = document.getElementById("modalSelect");

function openModal(title, help, text){
  modalTitle.textContent = title;
  modalHelp.textContent = help;
  modalText.value = text;
  overlay.style.display = "flex";
  overlay.setAttribute("aria-hidden","false");
  setTimeout(()=>{ modalText.focus(); modalText.select(); }, 50);
}
function closeModal(){
  overlay.style.display = "none";
  overlay.setAttribute("aria-hidden","true");
}

function legacyCopy(text){
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.top = '-9999px';
  ta.style.left = '-9999px';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  let ok = false;
  try{ ok = document.execCommand('copy'); }catch(e){ ok = false; }
  ta.remove();
  return ok;
}

async function tryCopy(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    return legacyCopy(text);
  }
}

modalClose.onclick = closeModal;
overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });
modalSelect.onclick = ()=>{ modalText.focus(); modalText.select(); };
modalCopy.onclick = async ()=>{
  const ok = await tryCopy(modalText.value);
  alert(ok ? "å·²è¤‡è£½ âœ…" : "è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹• Ctrl/Cmd+C");
};
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

// ---------- Buttons ----------
document.getElementById("btnReset").onclick = ()=>{
  document.getElementById("company").value = "å¥‡ç•°ç”ŸæŠ€è‚¡ä»½æœ‰é™å…¬å¸";
  document.getElementById("projectId").value = "";
  document.getElementById("reportDate").value = formatDateYYYYMMDD(new Date());

  document.getElementById("brand").value = "";
  document.getElementById("aud").value = "";
  document.getElementById("ing").value = "";
  document.getElementById("note").value = "";
  ["posChips","channelChips","packChips","matChips","colorChips","moodChips","typeChips","visualChips","avoidChips"]
    .forEach(cid=> setSelected(cid, []));

  updateAll();
};

document.getElementById("btnSample").onclick = ()=>{
  document.getElementById("company").value = "å¥‡ç•°ç”ŸæŠ€è‚¡ä»½æœ‰é™å…¬å¸";
  document.getElementById("projectId").value = (oemType === "cosmetic") ? "OEM-DEMO-001" : "HF-DEMO-001";
  document.getElementById("reportDate").value = formatDateYYYYMMDD(new Date());

  if(oemType === "cosmetic"){
    document.getElementById("brand").value = "ï¼ˆç¤ºç¯„ï¼‰æ²™é¾é«˜ç«¯è­·ç†ç³»åˆ—";
    document.getElementById("ptype").value = "é ­çš®ç²¾è¯";
    document.getElementById("aud").value = "æ²™é¾å°ˆæ¥­äººå£«ï¼é‡è¦–é ­çš®ç®¡ç†çš„æ¶ˆè²»è€…";
    document.getElementById("ing").value = "æ¤èƒã€èƒœè‚½ï¼ˆåˆè¦ç”¨èªç‚ºä¸»ï¼‰";
    document.getElementById("note").value = "å¸Œæœ›æœ‰é†«ç¾å‹å–„çš„ä¿¡ä»»æ„Ÿï¼Œä½†ä¸è¦é†«ç™‚å™¨æ¢°æ„Ÿï¼›åç•™ç™½ã€éœ§é¢ã€ä½èª¿å¥¢è¯ã€‚";

    setSelected("posChips", ["æ²™é¾å°ˆæ¥­","é«˜ç«¯ç²¾å“","æ¥µç°¡ç•™ç™½"]);
    setSelected("channelChips", ["æ²™é¾ B2B","å®˜ç¶²é›»å•†"]);
    setSelected("packChips", ["æ»´ç®¡","åœ“ç“¶"]);
    setSelected("matChips", ["éœ§é¢ç»ç’ƒ","ç´™ç›’å¤–åŒ…è£"]);
    setSelected("colorChips", ["è±¡ç‰™ç™½","éœ§é‡‘","éœ§ç°"]);
    setSelected("moodChips", ["å°ˆæ¥­å¯ä¿¡","ä½èª¿å¥¢è¯","ç†æ€§å…‹åˆ¶","é«˜ç´šæ„Ÿ"]);
    setSelected("typeChips", ["ç´°å­—æ¥µç°¡","å¤§ç•™ç™½ï¼‹å°å­—"]);
    setSelected("visualChips", ["æŠ½è±¡å…‰æ„Ÿ","ç·šæ¢æµå‹•"]);
    setSelected("avoidChips", ["éåº¦é†«ç™‚å™¨æ¢°æ„Ÿ","éåº¦ä¿ƒéŠ·é›»å•†æ„Ÿ","å»‰åƒ¹é‡‘å…‰é–ƒäº®"]);
  } else {
    document.getElementById("brand").value = "ï¼ˆç¤ºç¯„ï¼‰ä¸Šç­æ—æ™¶äº®è£œçµ¦";
    document.getElementById("ptype").value = "è† å›Š";
    document.getElementById("aud").value = "ä¸Šç­æ—ï¼é•·æ™‚é–“ç”¨çœ¼æ—ç¾¤ï¼ˆä»¥æ—¥å¸¸è£œå……èªå¢ƒï¼‰";
    document.getElementById("ing").value = "è‘‰é»ƒç´ ã€ç‰ç±³é»ƒç´ ï¼ˆä»¥æ—¥å¸¸è£œå……ã€ä¿é¤Šèªå¢ƒå‘ˆç¾ï¼‰";
    document.getElementById("note").value = "å¸Œæœ›ä¸»è¦–è¦ºå°ˆæ¥­å®‰å¿ƒã€å¯é•·æœŸè£œå……ï¼›é¿å…è—¥å“æ„Ÿèˆ‡é†«å¸«èƒŒæ›¸æš—ç¤ºã€‚";

    setSelected("posChips", ["å°ˆæ¥­ä¿å¥å“ç‰Œ","æ—¥å¸¸è£œå……å‹","ä¸Šç­æ—æ©Ÿèƒ½è£œçµ¦"]);
    setSelected("channelChips", ["å®˜ç¶²é›»å•†","è—¥å±€ / è—¥å¦é€šè·¯"]);
    setSelected("packChips", ["ç»ç’ƒç“¶","ç¦®ç›’çµ„"]);
    setSelected("matChips", ["ç»ç’ƒ","ç´™ç›’å¤–åŒ…è£"]);
    setSelected("colorChips", ["ç±³ç™½","æ·¡é»ƒ","æ·¡ç¶ "]);
    setSelected("moodChips", ["å°ˆæ¥­å¯ä¿¡","ä¹¾æ·¨ç´”æ·¨","ç†æ€§å…‹åˆ¶","é«˜ç´šæ„Ÿ"]);
    setSelected("typeChips", ["ç¾ä»£ç„¡è¥¯ç·š","è³‡è¨Šæ¸…æ™°å°å‘"]);
    setSelected("visualChips", ["ç„¡åœ–åƒï¼ˆç´”æ’ç‰ˆï¼‰","æŠ½è±¡å…‰æ„Ÿ"]);
    setSelected("avoidChips", ["éåº¦ä¿ƒéŠ·é›»å•†æ„Ÿ","å¼·çƒˆå°æ¯”åˆºçœ¼","å¤ªèŠ±å¤ªæ»¿"]);
  }

  updateAll();
};

async function copyMarkdown(){
  const text = document.getElementById("mdOut").textContent || "";
  const ok = await tryCopy(text);
  if(ok){
    alert("å·²è¤‡è£½ Markdown å ±å‘Š âœ…ï¼ˆå¯ç›´æ¥è²¼åˆ° Notion / Google Docï¼‰");
  }else{
    openModal(
      "Markdown å ±å‘Šï¼ˆè¤‡è£½å—é™å‚™æ´ï¼‰",
      "æ­¤ç’°å¢ƒå¯èƒ½é™åˆ¶å‰ªè²¼ç°¿ã€‚è«‹åœ¨æ­¤å…¨é¸å¾Œ Ctrl/Cmd+C è¤‡è£½ã€‚",
      text
    );
  }
}

document.getElementById("btnCopyMd").onclick = copyMarkdown;
document.getElementById("btnCopyMdInline").onclick = copyMarkdown;

document.getElementById("btnCopyPrompt").onclick = async ()=>{
  const text = document.getElementById("promptOut").textContent || "";
  const ok = await tryCopy(text);
  if(ok){
    alert("å·²è¤‡è£½ GEMINI CANVAS Prompt âœ…");
  }else{
    openModal(
      "GEMINI CANVAS Promptï¼ˆè¤‡è£½å—é™å‚™æ´ï¼‰",
      "æ­¤ç’°å¢ƒå¯èƒ½é™åˆ¶å‰ªè²¼ç°¿ã€‚è«‹åœ¨æ­¤å…¨é¸å¾Œ Ctrl/Cmd+C è¤‡è£½ã€‚",
      text
    );
  }
};

// ---------- Mode switch listeners ----------
document.querySelectorAll('input[name="oemType"]').forEach(radio=>{
  radio.addEventListener("change", (e)=>{
    oemType = e.target.value;
    applyOEMMode();

    // æ¸…æ‰å‹¾é¸ï¼Œé¿å…è·¨é ˜åŸŸæ®˜ç•™é€ æˆèª¤åˆ¤
    ["posChips","channelChips","packChips","matChips","colorChips","moodChips","typeChips","visualChips","avoidChips"]
      .forEach(cid=> setSelected(cid, []));

    updateAll();
  });
});

// ---------- Init ----------
(function init(){
  const reportDateEl = document.getElementById("reportDate");
  if(reportDateEl && !reportDateEl.value){
    reportDateEl.value = formatDateYYYYMMDD(new Date());
  }

  applyOEMMode();

  ["company","projectId","reportDate","brand","ptype","aud","ing","note"].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener("input", updateAll);
    el.addEventListener("change", updateAll);
  });

  updateAll();

  // Basic self-tests (console)
  (function runTests(){
    const results = [];
    const assert = (name, cond)=> results.push({name, pass: !!cond});
    try{ updateHeaderMeta(); assert("updateHeaderMeta does not throw", true); }
    catch(e){ assert("updateHeaderMeta does not throw", false); }
    const sel = collect();
    const prompt = buildPrompt(sel);
    assert("Prompt includes å…¬å¸æ¬„ä½", prompt.includes("å…¬å¸ï¼š"));
    const reg = evaluateRegulationRisk((sel.ing||"") + " " + (sel.note||""));
    assert("Regulation risk returns level", ["green","yellow","red"].includes(reg.level));
    console.log(`[OEM Switch Tool Tests] ${results.filter(r=>r.pass).length}/${results.length} passed`, results);
  })();
})();
</script>
</body>
</html>
